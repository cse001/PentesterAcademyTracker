from django.shortcuts import redirect,render
from lab import lab_update
from .models import Labs
# from course.models import Course as Labs
from django.db.models import Case, Value, When, Sum ,Count,IntegerField
def index(request):
    metrics = Labs.objects.values('course_name').annotate(topic_count=Count('topic_name',distinct=True)).annotate(lab_count=Count('lab_name')).annotate(completed=Sum('completed'))
    context ={
    'metrics':metrics,
    }
    return render(request,'lab/index.html',context)

def update(request):
    action = request.GET['action']
    if str(action) == "true":
        #This is where we will update the database !
        lab_update.lab_update()
        return redirect('http://localhost:8000/dashboard?msg1=Completed')
    else:
        return redirect('https://google.com')
    return HttpResponse("Hello, world. You're at the Course index.\n"+price_lte)

def details(request,course_name):
    course_details=Labs.objects.values('topic_name').annotate(tc=Sum('completed')).annotate(tv=Count('lab_name')).filter(course_name=course_name)
    context={
        "course_details":course_details,
        "course_name":course_name,
    }
    return render(request,'lab/topic.html',context)

def lab_details(request,course_name,topic_name):
    lab_details = Labs.objects.filter(course_name=course_name).filter(topic_name=topic_name)
    lab_url = lab_details[0].lab_link
    context = {
    'lab_details':lab_details,
    'topic_name':topic_name,
    'lab_url':lab_url,
    }
    return render(request,'lab/lab.html',context)
def updateCompletionStatus(request,course_name,topic_name,lab_name,status):
    lab_changed = Labs.objects.get(course_name=course_name,topic_name=topic_name,lab_name=lab_name)
    lab_changed.completed = int(status)
    lab_changed.save()
    return redirect('lab_details',course_name,topic_name)
